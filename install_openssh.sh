#!/bin/bash

# Descarga del archivo fuente de OpenSSH
wget https://launchpad.net/ubuntu/+archive/primary/+sourcefiles/openssh/1:9.6p1-3ubuntu13.4/openssh_9.6p1.orig.tar.gz

# Detener el servicio sshd
systemctl stop sshd

# Eliminar los paquetes de OpenSSH existentes
apt-get remove -y openssh-server openssh-client
apt-get purge -y openssh-server openssh-client

# Actualizar los repositorios
apt update

# Instalar las dependencias necesarias
apt install -y build-essential zlib1g-dev libssl-dev libpam0g-dev libselinux1-dev libwrap0-dev libedit-dev libbsd-dev autoconf automake libtool pkg-config wget curl git

# Extraer el archivo fuente de OpenSSH
tar zxvf openssh_9.6p1.orig.tar.gz

# Cambiar al directorio del c칩digo fuente
cd openssh-9.6p1/

# Configurar la compilaci칩n
./configure --prefix=/usr --sysconfdir=/etc/ssh

# Compilar el c칩digo fuente
make

# Instalar el nuevo OpenSSH
make install

# Crear el usuario sshd
useradd -r -d /usr/local/sbin/sshd -s /sbin/nologin -c "sshd Privilege Separation User" sshd

# Crear el archivo de servicio para systemd
cat <<EOL > /etc/systemd/system/sshd.service
[Unit]
Description=OpenSSH server daemon
After=network.target

[Service]
ExecStart=/usr/sbin/sshd -D
ExecReload=/bin/kill -HUP \$MAINPID
KillMode=process
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOL

# Recargar los demonios de systemd para reconocer el nuevo servicio
systemctl daemon-reload

# Iniciar el servicio sshd
systemctl start sshd

# Habilitar el servicio sshd para que se inicie autom치ticamente en el arranque
systemctl enable sshd
